define("ndi/model/0.1.0/model",["ndi/render/0.58.0/render","ndi/events/0.1.0/events","ndi/loader/0.1.0/loader"],function(a,b,c){function d(a,b){var c=i[a];return-1===c.indexOf(b)&&(console.warn("类型错误，必须为",c,"之一！"),b=c[0]),b}function e(a,b,c){return"object"!=typeof this||this instanceof e?(this.app=b,void 0!==a.id&&(this.id=a.id,b.setHash(this),RegExp(b.get("yunid")).test(this.id)&&!a.type&&(a.type="yun")),this.render=null,this.materials=[],this.attributes={},this.val(a),this.__init__(b,c),void 0):new e(a,b,c)}var f=a("ndi/render/0.58.0/render"),g=a("ndi/events/0.1.0/events"),h=a("ndi/loader/0.1.0/loader"),i={type:["own","load","yun","json"],geo:["cube","plane"],load:["json"]};g.mixTo(e),e.prototype.__init__=function(a,b){function c(a,c){function g(a){for(var b=a.material.materials,c=0,d=b.length;d>c;c++){var e=b[c];e.skinning=!0}}"mesh"===d.renderType&&(a.skinWeights&&a.skinWeights.length?(model=new f.SkinnedMesh(a,c),g(model),f.AnimationHandler.add(model.geometry.animation),animation=new f.Animation(model,"animation",f.AnimationHandler.CATMULLROM),animation.play(),e.app.run(function(){animation.update(.01)})):model=new f.Mesh(a,c)),model.position=d.position,model.rotation=d.rotation,e.render=model,b&&b.call(e,this)}var d=this.attributes;d.mat;var e=this;switch(d.type){case"own":this.createOwnMesh(c);break;case"load":this.createLoadMesh(c);break;case"json":this.createJsonMesh(c);break;case"yun":this.createYunMesh(c)}},e.prototype.createOwnMesh=function(a){var b,c=this.attributes,d=f.CubeGeometry,e=c.geometryAttrs;switch(c.geometryType){case"cube":d=f.CubeGeometry;break;case"plane":d=f.PlaneGeometry}b=new d(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]);var g=c.materials;return g&&g.length?this.getMaterials(g,function(c){a(b,c.materials[0])}):a(b,void 0),this},e.prototype.createYunMesh=function(a){var b=this,c=this.attributes,d=this.app,e=new h({url:d.get("yunHost")+"/model/"+this.id}),g=new f.JSONLoader;return e.on("start",function(a){c.loadStart&&d.cmd(c.loadStart,a)}),e.on("progress",function(a){c.loadProgress&&d.cmd(c.loadProgress,a)}),e.on("complete",function(e){c.loadComplete&&d.cmd(c.loadComplete,e);var f=e.data;f.data.materials=f.materials;var h=g.parse(f.data);b.getMaterials(f.materials,function(b){a(h.geometry,b)})}),e.load(),this},e.prototype.createLoadMesh=function(a){var b,c=this,d=this.app,e=this.attributes,g=new h({url:e.url}),i=["map","lightMap","specularMap","bumpMap","normalMap"];return"json"===e.loadType&&(b=new f.JSONLoader),g.on("start",function(a){e.loadStart&&d.cmd(e.loadStart,a)}),g.on("progress",function(a){e.loadProgress&&d.cmd(e.loadProgress,a)}),g.on("complete",function(f){e.loadComplete&&d.cmd(e.loadComplete,f);var g=f.url.split("/");g.pop();var h=b.parse(f.data,(g.length<1?".":g.join("/"))+"/");c.getMaterials(h.materials,function(b){h.materials.forEach(function(a,c){i.forEach(function(d){a[d]&&(b.materials[c][d]=a[d])})}),a(h.geometry,b)})}),g.load(),this},e.prototype.createJsonMesh=function(a){var b=this.attributes,c=new f.JSONLoader,d=c.parse(b.json,"__delay__");return this.getMaterials(d.materials,function(b){a(d.geometry,b)}),this},e.prototype.getMaterials=function(a,b){var c=this;return a=a||[{color:10263708}],this.app.async.map(a,function(a,b){"string"==typeof a?a={id:a}:a.id=a._id,c.app.material(a.val?a.val():a,b)},function(a,d){var e=[];c.materials=[],c.attributes.materials=d.map(function(a){return e.push(a.material.render),c.materials.push(a.material),a.material.id}),b&&b(e.length?new f.MeshFaceMaterial(e):new f.MeshPhongMaterial)}),this},e.prototype.val=function(a){var b=this.attributes;if(void 0===a){var c={id:this.id,type:b.type,renderType:b.renderType,position:this.render.position.val(),rotation:this.render.rotation.val()};return"own"===c.type?c.geometryType=b.geometryType:"load"===c.type&&(c.url=b.url,c.loadType=b.loadType),c}b.type=d("type",a.type||"own"),b.renderType=a.renderType||"mesh",b.position=new f.Vector3,b.rotation=new f.Vector3,a.position&&b.position.val(a.position),a.rotation&&b.rotation.val(a.rotation),b.materials=a.materials||[],b.loadStart=a.loadStart,b.loadProgress=a.loadProgress,b.loadComplete=a.loadComplete,"own"===b.type?(b.geometryType=d("geo",a.geometryType||"cube"),b.geometryAttrs=a.geometryAttrs||[]):"load"===b.type?(a.url||console.error("url 不可为空！"),b.url=a.url,b.loadType=d("load",a.loadType||"json")):"yun"===b.type?RegExp(this.app.get("yunid")).test(this.id)||console.error("ID:"+this.id+"格式不正确！"):"json"===b.type&&(a.json||console.error("json 不可为空！"),b.json=a.json);var e=this.render;e&&(e.position.val(b.position),e.rotation.val(b.rotation))},e.prototype.updateMap=function(){var a=this.render.geometry,b=this.render.material;b.materials?b.materials.forEach(function(a){a.needsUpdate=!0}):b.needsUpdate=!0,a.buffersNeedUpdate=!0,a.uvsNeedUpdate=!0},e.prototype.updateMaterial=function(){var a=this.materials.map(function(a){return a.render});this.render.material.materials=a},e.prototype.get=function(a){return this.attributes[a]},e.prototype.set=function(){},c.exports=e});
